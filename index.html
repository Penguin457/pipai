<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PipAI - Advanced AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      body {
        background: #f7f7f8;
      }

      .dark-mode {
        background: #212121;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }
      .dark-mode ::-webkit-scrollbar-thumb {
        background: #4b5563;
      }

      /* Chat bubbles */
      .user-message {
        background: #f4f4f4;
        color: #374151;
      }
      .dark-mode .user-message {
        background: #2d2d30;
        color: #e5e7eb;
      }

      .ai-message {
        background: transparent;
        border-left: 3px solid #10b981;
        padding-left: 16px;
      }

      /* Enhanced drag & drop zone */
      .drop-zone {
        border: 2px dashed #cbd5e0;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        background: #f9fafb;
        position: relative;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .drop-zone.dragover {
        border-color: #10b981;
        background: #f0fdf4;
        transform: scale(1.02);
      }
      .dark-mode .drop-zone {
        background: #2d3748;
        border-color: #4a5568;
      }
      .dark-mode .drop-zone.dragover {
        border-color: #10b981;
        background: #1a202c;
      }

      /* Image preview styles */
      .image-preview {
        position: relative;
        display: inline-block;
        margin: 8px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .image-preview img {
        max-width: 150px;
        max-height: 150px;
        object-fit: cover;
      }
      .image-preview .remove-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 14px;
      }

      /* Progress bar */
      .progress-bar {
        width: 100%;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin: 8px 0;
      }
      .progress-fill {
        height: 100%;
        background: #10b981;
        transition: width 0.3s ease;
      }

      /* Feature buttons */
      .feature-btn {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        min-width: 100px;
      }
      .feature-btn:hover {
        background: #f9fafb;
        border-color: #10b981;
        transform: translateY(-2px);
      }
      .dark-mode .feature-btn {
        background: #2d3748;
        border-color: #4a5568;
        color: #e5e7eb;
      }
      .dark-mode .feature-btn:hover {
        background: #4a5568;
      }

      /* Image gallery styles */
      .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
        margin: 12px 0;
      }

      .image-item {
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        aspect-ratio: 1;
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      .image-item:hover {
        transform: scale(1.05);
      }
      .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .image-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        color: white;
        padding: 8px;
        font-size: 0.75rem;
      }

      /* Modal styles */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
      }
      .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 2rem;
        cursor: pointer;
      }

      /* Button styles */
      .btn-primary {
        background: #10b981;
        color: white;
        transition: all 0.2s ease;
      }
      .btn-primary:hover {
        background: #059669;
      }
      .btn-primary:disabled {
        background: #d1d5db;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: transparent;
        border: 1px solid #d1d5db;
        color: #6b7280;
        transition: all 0.2s ease;
      }
      .btn-secondary:hover {
        background: #f9fafb;
        border-color: #9ca3af;
      }
      .dark-mode .btn-secondary {
        border-color: #4b5563;
        color: #9ca3af;
      }
      .dark-mode .btn-secondary:hover {
        background: #374151;
        border-color: #6b7280;
      }

      /* Enhanced input styling */
      .chat-input-container {
        position: relative;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }
      .chat-input-container:focus-within {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      }
      .dark-mode .chat-input-container {
        background: #40414f;
        border-color: #565869;
      }

      .chat-input {
        background: transparent;
        border: none;
        outline: none;
        padding: 16px;
        width: 100%;
        resize: none;
        color: inherit;
      }
      .dark-mode .chat-input {
        color: #e5e7eb;
      }

      /* Loading animation */
      .typing-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #9ca3af;
        animation: typing 1.4s infinite ease-in-out;
      }
      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          opacity: 0.3;
        }
        40% {
          opacity: 1;
        }
      }

      /* Sidebar styles */
      .sidebar {
        background: white;
        border-right: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }
      .dark-mode .sidebar {
        background: #171717;
        border-color: #2d2d30;
      }

      .history-item {
        transition: all 0.2s ease;
      }
      .history-item:hover {
        background: #f9fafb;
      }
      .dark-mode .history-item:hover {
        background: #2d2d30;
      }

      /* Main chat area */
      .chat-container {
        background: white;
      }
      .dark-mode .chat-container {
        background: #212121;
      }

      /* Header styles */
      .header-minimal {
        border-bottom: 1px solid #e5e7eb;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
      }
      .dark-mode .header-minimal {
        border-color: #2d2d30;
        background: rgba(33, 33, 33, 0.8);
      }

      /* Rate limit warning */
      .rate-limit-warning {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        color: #92400e;
      }
      .dark-mode .rate-limit-warning {
        background: #451a03;
        border-color: #92400e;
        color: #fbbf24;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
          position: fixed;
          z-index: 50;
          height: 100vh;
        }
        .sidebar.open {
          transform: translateX(0);
        }
        .image-gallery {
          grid-template-columns: repeat(2, 1fr);
        }
        .feature-btn {
          min-width: 80px;
          padding: 8px;
        }
      }

      /* Sparkle animation for enhanced features */
      @keyframes sparkle {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }
      .sparkle {
        animation: sparkle 2s infinite;
      }
    </style>
  </head>
  <body class="h-screen flex overflow-hidden">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar w-80 flex-shrink-0 flex flex-col">
      <!-- Sidebar Header -->
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <button
          id="new-chat-btn"
          class="btn-primary w-full py-3 px-4 rounded-lg font-medium flex items-center justify-center gap-2"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 5v14M5 12h14" />
          </svg>
          New chat
        </button>
      </div>

      <!-- Feature Panel -->
      <div class="p-3 border-b border-gray-200 dark:border-gray-700">
        <div class="text-xs font-semibold text-gray-500 mb-2">AI FEATURES</div>
        <div class="grid grid-cols-2 gap-2">
          <button class="feature-btn" onclick="toggleVoiceMode()">
            <span class="sparkle">🎤</span>
            <span class="text-xs">Voice</span>
          </button>
          <button class="feature-btn" onclick="toggleOCRMode()">
            <span class="sparkle">📄</span>
            <span class="text-xs">OCR</span>
          </button>
          <button class="feature-btn" onclick="generateQR()">
            <span class="sparkle">📱</span>
            <span class="text-xs">QR Code</span>
          </button>
          <button class="feature-btn" onclick="toggleTranslator()">
            <span class="sparkle">🌐</span>
            <span class="text-xs">Translate</span>
          </button>
        </div>
      </div>

      <!-- Chat History -->
      <div class="flex-1 overflow-y-auto p-2">
        <div id="history-list" class="space-y-1">
          <!-- History items will be populated here -->
        </div>
      </div>

      <!-- Sidebar Footer -->
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
        <div
          id="rate-limit-status"
          class="text-xs text-gray-500 text-center py-2"
        >
          Questions: <span id="question-count">0</span>/10 per minute
        </div>
        <button
          id="clear-history-btn"
          class="btn-secondary w-full py-2 px-4 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          </svg>
          Clear conversations
        </button>
        <button
          id="theme-toggle"
          class="btn-secondary w-full py-2 px-4 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="12" cy="12" r="4" />
            <path d="M12 1v6m0 6v6" />
          </svg>
          Dark mode
        </button>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col chat-container">
      <!-- Header -->
      <div class="header-minimal p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button
            id="sidebar-toggle"
            class="md:hidden p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 12h18M3 6h18M3 18h18" />
            </svg>
          </button>
          <div class="flex items-center gap-2">
            <span class="text-2xl sparkle">🐧</span>
            <span class="font-semibold text-gray-900 dark:text-white"
              >PipAI</span
            >
            <span
              class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full"
              >Enhanced</span
            >
          </div>
        </div>
        <div class="text-sm text-gray-500">
          Made by Prahath • Advanced AI Assistant
        </div>
      </div>

      <!-- Rate Limit Warning -->
      <div
        id="rate-limit-warning"
        class="hidden rate-limit-warning mx-4 mt-2 p-3 rounded-lg text-sm"
      >
        <div class="flex items-center gap-2">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
            />
          </svg>
          <span
            >You've reached the 10 questions per minute limit. Please wait
            <span id="cooldown-time">60</span> seconds. 🐧</span
          >
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="chat-container" class="flex-1 overflow-y-auto">
        <div class="max-w-4xl mx-auto px-4 py-6">
          <!-- Messages will be populated here -->
        </div>
      </div>

      <!-- Enhanced Input Area -->
      <div class="p-4 border-t border-gray-200 dark:border-gray-700">
        <div class="max-w-4xl mx-auto">
          <!-- Image Upload Area -->
          <div id="image-upload-area" class="mb-4 hidden">
            <div id="drop-zone" class="drop-zone">
              <svg
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1"
                class="text-gray-400 mb-2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7,10 12,15 17,10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              <p class="text-gray-600 dark:text-gray-300 mb-2">
                Drag & drop images here or click to browse
              </p>
              <p class="text-xs text-gray-400">
                Supports JPG, PNG, GIF, WebP up to 10MB
              </p>
              <input
                type="file"
                id="file-input"
                multiple
                accept="image/*"
                class="hidden"
              />
            </div>
            <div id="image-preview-container" class="mt-4"></div>
          </div>

          <!-- Progress bar for OCR -->
          <div id="ocr-progress" class="mb-4 hidden">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm text-gray-600 dark:text-gray-300"
                >Processing image...</span
              >
              <span id="ocr-status" class="text-xs text-gray-400"></span>
            </div>
            <div class="progress-bar">
              <div
                id="progress-fill"
                class="progress-fill"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <!-- Main input form -->
          <form id="chat-form">
            <div class="chat-input-container">
              <textarea
                id="message-input"
                class="chat-input"
                rows="1"
                placeholder="Message PipAI... Try uploading images, asking for translations, or generating QR codes! 🐧"
                style="resize: none; overflow: hidden"
              ></textarea>

              <!-- Input toolbar -->
              <div class="flex items-center justify-between px-4 pb-2">
                <div class="flex items-center gap-2">
                  <button
                    type="button"
                    id="image-btn"
                    class="p-2 text-gray-400 hover:text-gray-600 rounded"
                    title="Upload images"
                  >
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                      <circle cx="8.5" cy="8.5" r="1.5" />
                      <polyline points="21,15 16,10 5,21" />
                    </svg>
                  </button>
                  <button
                    type="button"
                    id="voice-btn"
                    class="p-2 text-gray-400 hover:text-gray-600 rounded"
                    title="Voice input"
                  >
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                      />
                      <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                      <line x1="12" y1="19" x2="12" y2="23" />
                      <line x1="8" y1="23" x2="16" y2="23" />
                    </svg>
                  </button>
                  <button
                    type="button"
                    id="emoji-btn"
                    class="p-2 text-gray-400 hover:text-gray-600 rounded"
                    title="Add emoji"
                  >
                    <span class="text-lg">😊</span>
                  </button>
                </div>
                <button
                  type="submit"
                  id="send-button"
                  class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2"
                >
                  <span>Send</span>
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M22 2 11 13M22 2l-7 20-4-9-9-4z" />
                  </svg>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="modal hidden" onclick="closeImageModal()">
      <span class="modal-close">&times;</span>
      <img id="modal-image" src="" alt="" />
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="modal hidden" onclick="closeQRModal()">
      <div
        class="bg-white p-6 rounded-lg max-w-sm w-full mx-4"
        onclick="event.stopPropagation()"
      >
        <h3 class="text-lg font-semibold mb-4">Generate QR Code</h3>
        <input
          type="text"
          id="qr-input"
          placeholder="Enter text or URL"
          class="w-full p-2 border rounded mb-4"
        />
        <div class="flex gap-2">
          <button
            onclick="generateQRCode()"
            class="btn-primary px-4 py-2 rounded flex-1"
          >
            Generate
          </button>
          <button
            onclick="closeQRModal()"
            class="btn-secondary px-4 py-2 rounded"
          >
            Cancel
          </button>
        </div>
        <div id="qr-result" class="mt-4 text-center"></div>
      </div>
    </div>

    <script>
      // DOM elements
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebar-toggle");
      const chatContainer = document.getElementById("chat-container");
      const chatForm = document.getElementById("chat-form");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const historyList = document.getElementById("history-list");
      const newChatBtn = document.getElementById("new-chat-btn");
      const clearHistoryBtn = document.getElementById("clear-history-btn");
      const themeToggle = document.getElementById("theme-toggle");
      const rateLimitWarning = document.getElementById("rate-limit-warning");
      const questionCount = document.getElementById("question-count");
      const cooldownTime = document.getElementById("cooldown-time");
      const imageModal = document.getElementById("image-modal");
      const modalImage = document.getElementById("modal-image");

      // Enhanced input elements
      const imageBtn = document.getElementById("image-btn");
      const voiceBtn = document.getElementById("voice-btn");
      const emojiBtn = document.getElementById("emoji-btn");
      const imageUploadArea = document.getElementById("image-upload-area");
      const dropZone = document.getElementById("drop-zone");
      const fileInput = document.getElementById("file-input");
      const imagePreviewContainer = document.getElementById(
        "image-preview-container"
      );
      const ocrProgress = document.getElementById("ocr-progress");
      const progressFill = document.getElementById("progress-fill");
      const ocrStatus = document.getElementById("ocr-status");

      let messages = [
        {
          role: "system",
          content:
            "You are PipAI, an advanced penguin-themed AI assistant created by Prahath Kambaiyyagari. You have enhanced capabilities including image analysis, OCR text extraction, voice interaction, translation, and QR code generation. Always be enthusiastic, helpful, and include penguin emojis 🐧. When users upload images, analyze them thoroughly. For OCR requests, extract and format text clearly. Be conversational and showcase your advanced features naturally.",
        },
      ];

      let currentChatId = Date.now().toString();
      let isLoading = false;
      let uploadedImages = [];
      let isVoiceMode = false;
      let isOCRMode = false;

      // Rate limiting variables (increased for enhanced features)
      let questionTimestamps = [];
      const MAX_QUESTIONS_PER_MINUTE = 10;
      const RATE_LIMIT_WINDOW = 60 * 1000;
      let cooldownTimer = null;

      // API Keys
      const cerebrasApiKey =
        "csk-h365v4k4ewm49wc6nxpk3mhk8cjvtyf8t8xymfkm6y5wprkt";
      const OMDB_API_KEY = "6ec7938";
      const NEWSAPI_KEY = "8796b7206c754d948212c09b24b6c51c";
      const PEXELS_API_KEY =
        "vDuHqfCFC7CPcWiEgpkpyvHeBLRbcrfYkjHRbT39gVO7tsjTGjtiEn61";
      const GIPHY_API_KEY = "kWzkOt20JaBn4KvElnzzgSLhNal2Nn7i";

      // Auto-resize textarea
      function autoResizeTextarea() {
        messageInput.style.height = "auto";
        messageInput.style.height =
          Math.min(messageInput.scrollHeight, 120) + "px";
      }
      messageInput.addEventListener("input", autoResizeTextarea);

      // Enhanced Feature Functions
      function toggleVoiceMode() {
        isVoiceMode = !isVoiceMode;
        const btn = voiceBtn;
        if (isVoiceMode) {
          btn.classList.add("text-red-500");
          startVoiceRecognition();
        } else {
          btn.classList.remove("text-red-500");
          stopVoiceRecognition();
        }
      }

      function toggleOCRMode() {
        isOCRMode = !isOCRMode;
        messageInput.placeholder = isOCRMode
          ? "OCR Mode: Upload images to extract text! 🐧📄"
          : "Message PipAI... Try uploading images, asking for translations, or generating QR codes! 🐧";
      }

      function toggleTranslator() {
        const currentText = messageInput.value;
        if (currentText) {
          messageInput.value = `Translate this: "${currentText}"`;
        } else {
          messageInput.value = "Translate: ";
          messageInput.focus();
        }
      }

      function generateQR() {
        document.getElementById("qr-modal").classList.remove("hidden");
        document.getElementById("qr-input").focus();
      }

      function closeQRModal() {
        document.getElementById("qr-modal").classList.add("hidden");
      }

      function generateQRCode() {
        const text = document.getElementById("qr-input").value;
        if (!text) return;

        const qrResult = document.getElementById("qr-result");
        qrResult.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(
          text
        )}" alt="QR Code" class="mx-auto border rounded">`;
      }

      // Voice Recognition
      let recognition = null;
      function startVoiceRecognition() {
        if (
          "webkitSpeechRecognition" in window ||
          "SpeechRecognition" in window
        ) {
          recognition = new (window.SpeechRecognition ||
            window.webkitSpeechRecognition)();
          recognition.continuous = true;
          recognition.interimResults = true;

          recognition.onresult = function (event) {
            let interimTranscript = "";
            let finalTranscript = "";

            for (let i = event.resultIndex; i < event.results.length; i++) {
              if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
              } else {
                interimTranscript += event.results[i][0].transcript;
              }
            }

            messageInput.value = finalTranscript + interimTranscript;
            autoResizeTextarea();
          };

          recognition.start();
        } else {
          alert("Speech recognition not supported in this browser 🐧");
          isVoiceMode = false;
          voiceBtn.classList.remove("text-red-500");
        }
      }

      function stopVoiceRecognition() {
        if (recognition) {
          recognition.stop();
          recognition = null;
        }
      }

      // Enhanced Drag & Drop Image Handling
      function setupImageUpload() {
        // Show/hide upload area
        imageBtn.addEventListener("click", () => {
          imageUploadArea.classList.toggle("hidden");
          if (!imageUploadArea.classList.contains("hidden")) {
            dropZone.classList.add("sparkle");
            setTimeout(() => dropZone.classList.remove("sparkle"), 2000);
          }
        });

        // File input
        fileInput.addEventListener("change", handleFiles);
        dropZone.addEventListener("click", () => fileInput.click());

        // Drag & Drop
        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragleave", (e) => {
          e.preventDefault();
          dropZone.classList.remove("dragover");
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("dragover");
          handleFiles({ target: { files: e.dataTransfer.files } });
        });
      }

      function handleFiles(event) {
        const files = Array.from(event.target.files);
        files.forEach((file) => {
          if (file.type.startsWith("image/") && file.size <= 10 * 1024 * 1024) {
            processImage(file);
          } else {
            showNotification("Please upload images under 10MB 🐧", "warning");
          }
        });
      }

      function processImage(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const imageData = {
            name: file.name,
            data: e.target.result,
            file: file,
          };
          uploadedImages.push(imageData);
          displayImagePreview(imageData);

          if (isOCRMode) {
            extractTextFromImage(imageData);
          }
        };
        reader.readAsDataURL(file);
      }

      function displayImagePreview(imageData) {
        const preview = document.createElement("div");
        preview.className = "image-preview";
        preview.innerHTML = `
                <img src="${imageData.data}" alt="${imageData.name}">
                <button class="remove-btn" onclick="removeImage('${imageData.name}')">&times;</button>
                <div class="text-xs text-gray-600 p-2">${imageData.name}</div>
            `;
        imagePreviewContainer.appendChild(preview);
      }

      function removeImage(imageName) {
        uploadedImages = uploadedImages.filter((img) => img.name !== imageName);
        const preview = Array.from(imagePreviewContainer.children).find(
          (child) => child.querySelector("img")?.alt === imageName
        );
        if (preview) preview.remove();
      }

      // OCR Text Extraction
      async function extractTextFromImage(imageData) {
        ocrProgress.classList.remove("hidden");
        ocrStatus.textContent = "Initializing OCR...";
        progressFill.style.width = "10%";

        try {
          const worker = await Tesseract.createWorker({
            logger: (m) => {
              if (m.status === "recognizing text") {
                const progress = Math.round(m.progress * 100);
                progressFill.style.width = `${10 + progress * 0.8}%`;
                ocrStatus.textContent = `Recognizing text... ${progress}%`;
              }
            },
          });

          const {
            data: { text },
          } = await worker.recognize(imageData.data);
          await worker.terminate();

          ocrProgress.classList.add("hidden");

          if (text.trim()) {
            messageInput.value += `\n\nExtracted text from ${
              imageData.name
            }:\n${text.trim()}`;
            autoResizeTextarea();
            showNotification("Text extracted successfully! 🐧📄", "success");
          } else {
            showNotification("No text found in image 🐧", "info");
          }
        } catch (error) {
          ocrProgress.classList.add("hidden");
          showNotification("OCR failed: " + error.message, "error");
        }
      }

      // Notification system
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `fixed top-4 right-4 p-3 rounded-lg text-white z-50 ${
          type === "success"
            ? "bg-green-500"
            : type === "warning"
            ? "bg-yellow-500"
            : type === "error"
            ? "bg-red-500"
            : "bg-blue-500"
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // Enhanced emoji picker
      const emojis = [
        "😀",
        "😂",
        "🤔",
        "👍",
        "❤️",
        "🐧",
        "🚀",
        "✨",
        "🎉",
        "🔥",
      ];
      emojiBtn.addEventListener("click", () => {
        const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
        messageInput.value += randomEmoji;
        messageInput.focus();
      });

      // API Functions (keeping existing ones)
      async function searchImages(query, count = 6) {
        try {
          console.log("Searching images for:", query);
          const response = await fetch(
            `https://api.pexels.com/v1/search?query=${encodeURIComponent(
              query
            )}&per_page=${count}&orientation=square`,
            {
              headers: { Authorization: PEXELS_API_KEY },
            }
          );
          if (!response.ok)
            throw new Error(`Pexels API error: ${response.status}`);
          const data = await response.json();
          return data.photos || [];
        } catch (error) {
          console.error("Error searching images:", error);
          return [];
        }
      }

      async function searchGifs(query, limit = 6) {
        try {
          const result = await fetch(
            `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(
              query
            )}&limit=${limit}&rating=pg`
          );
          if (!result.ok) throw new Error(`Giphy API error: ${result.status}`);
          const data = await result.json();
          return data.data || [];
        } catch (error) {
          console.error("Giphy GIF search error:", error);
          return [];
        }
      }

      async function searchMovies(query) {
        try {
          const url = `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&s=${encodeURIComponent(
            query
          )}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`OMDB API error: ${res.status}`);
          const data = await res.json();
          if (data.Response === "True") return data.Search || [];
          return [];
        } catch (error) {
          console.error("OMDB search error:", error);
          return [];
        }
      }

      async function searchNews(query) {
        try {
          const url = `https://newsapi.org/v2/everything?q=${encodeURIComponent(
            query
          )}&apiKey=${NEWSAPI_KEY}&language=en&pageSize=4`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`NewsAPI error: ${res.status}`);
          const data = await res.json();
          return data.articles || [];
        } catch (error) {
          console.error("NewsAPI search error:", error);
          return [];
        }
      }

      // Gallery creation functions (keeping existing)
      function createImageGallery(images, query) {
        if (!images || images.length === 0) {
          return `<div class="text-gray-500 text-sm py-4">No images found for "${query}" 🐧</div>`;
        }

        const galleryHtml = images
          .map(
            (image) => `
                <div class="image-item" onclick="openImageModal('${
                  image.src.large
                }', '${image.alt || query}')">
                    <img src="${image.src.medium}" alt="${
              image.alt || query
            }" loading="lazy">
                    <div class="image-overlay">
                        <div class="truncate">${image.alt || query}</div>
                        <div class="text-xs opacity-75">Photo by ${
                          image.photographer
                        }</div>
                    </div>
                </div>
            `
          )
          .join("");

        return `<div class="image-gallery">${galleryHtml}</div>`;
      }

      function createGifGallery(gifs, query) {
        if (!gifs || gifs.length === 0) {
          return `<div class="text-gray-500 text-sm py-4">No gifs found for "${query}" 🐧</div>`;
        }
        return `
                <div class="image-gallery">
                    ${gifs
                      .map(
                        (gif) => `
                        <div class="image-item" onclick="openImageModal('${
                          gif.images.original.url
                        }', '${query}')">
                            <img src="${
                              gif.images.fixed_width.url
                            }" alt="${query}" loading="lazy" />
                            <div class="image-overlay">
                                <div class="truncate">${
                                  gif.title || query
                                }</div>
                                <div class="text-xs opacity-75">via Giphy</div>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
      }

      function createMovieList(movies) {
        if (!movies || movies.length === 0) {
          return `<div class="text-gray-500 text-sm py-4">No movies found 🐧</div>`;
        }
        return `
                <div class="mt-3">
                    <div class="font-bold mb-2">Movies found:</div>
                    ${movies
                      .map(
                        (movie) => `
                        <div class="flex items-center gap-3 mb-3 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                            <img src="${
                              movie.Poster !== "N/A" ? movie.Poster : ""
                            }" alt="${
                          movie.Title
                        }" class="w-12 h-16 object-cover rounded">
                            <div>
                                <div class="font-semibold">${movie.Title}</div>
                                <div class="text-sm text-gray-500">${
                                  movie.Year
                                } • ${movie.Type}</div>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
      }

      function createNewsList(articles) {
        if (!articles || articles.length === 0) {
          return `<div class="text-gray-500 text-sm py-4">No news found 🐧</div>`;
        }
        return `
                <div class="mt-3">
                    <div class="font-bold mb-2">News articles:</div>
                    ${articles
                      .map(
                        (article) => `
                        <div class="mb-3 p-3 bg-gray-50 dark:bg-gray-800 rounded">
                            <a href="${
                              article.url
                            }" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline font-semibold">
                                ${article.title}
                            </a>
                            <div class="text-sm text-gray-500 mt-1">
                                ${article.source.name} ${
                          article.author ? `• by ${article.author}` : ""
                        }
                            </div>
                            <div class="text-sm mt-2">${
                              article.description || ""
                            }</div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
      }

      // Modal functions
      function openImageModal(imageSrc, altText) {
        modalImage.src = imageSrc;
        modalImage.alt = altText;
        imageModal.classList.remove("hidden");
      }

      function closeImageModal() {
        imageModal.classList.add("hidden");
        modalImage.src = "";
      }

      // Content detection functions (keeping existing)
      function isImageRequest(message) {
        const imageKeywords = [
          "image",
          "images",
          "picture",
          "pictures",
          "photo",
          "photos",
          "show me",
          "find images",
          "search images",
          "visual",
          "pic",
          "pics",
        ];
        const lowerMessage = message.toLowerCase();
        return (
          imageKeywords.some((keyword) => lowerMessage.includes(keyword)) &&
          !isGifRequest(message)
        );
      }

      function isGifRequest(message) {
        const gifKeywords = ["gif", "gifs", "animated"];
        const lowerMessage = message.toLowerCase();
        return gifKeywords.some((keyword) => lowerMessage.includes(keyword));
      }

      function isMovieRequest(message) {
        const movieKeywords = ["movie", "movies", "film", "films"];
        const lowerMessage = message.toLowerCase();
        return movieKeywords.some((keyword) => lowerMessage.includes(keyword));
      }

      function isNewsRequest(message) {
        const newsKeywords = [
          "news",
          "headline",
          "headlines",
          "article",
          "articles",
        ];
        const lowerMessage = message.toLowerCase();
        return newsKeywords.some((keyword) => lowerMessage.includes(keyword));
      }

      function extractQuery(message, keywords) {
        const lowerMessage = message.toLowerCase();
        let query = lowerMessage;

        keywords.forEach((keyword) => {
          query = query.replace(new RegExp(keyword, "gi"), "");
        });

        query = query
          .replace(/show me/g, "")
          .replace(/find/g, "")
          .replace(/search/g, "")
          .replace(/of/g, "")
          .replace(/about/g, "")
          .trim();

        return query || "penguin";
      }

      function createContextData(
        movies,
        news,
        images,
        gifs,
        uploadedImages = []
      ) {
        let contextData = "";

        if (uploadedImages.length > 0) {
          contextData += "\nUploaded images:\n";
          uploadedImages.forEach((img, index) => {
            contextData += `- Image ${index + 1}: ${img.name}\n`;
          });
        }

        if (movies && movies.length > 0) {
          contextData += "\nMovie data:\n";
          movies.forEach((movie) => {
            contextData += `- ${movie.Title} (${movie.Year}) - ${movie.Type}\n`;
          });
        }

        if (news && news.length > 0) {
          contextData += "\nNews articles:\n";
          news.forEach((article) => {
            contextData += `- ${article.title} (${article.source.name}): ${article.description}\n`;
          });
        }

        if (images && images.length > 0) {
          contextData += `\nFound ${images.length} images available for display.\n`;
        }

        if (gifs && gifs.length > 0) {
          contextData += `\nFound ${gifs.length} GIFs available for display.\n`;
        }

        return contextData;
      }

      // Rate limiting functions (updated for higher limit)
      function updateQuestionCount() {
        const now = Date.now();
        questionTimestamps = questionTimestamps.filter(
          (timestamp) => now - timestamp < RATE_LIMIT_WINDOW
        );
        questionCount.textContent = questionTimestamps.length;

        const isAtLimit = questionTimestamps.length >= MAX_QUESTIONS_PER_MINUTE;
        sendButton.disabled = isAtLimit || isLoading;
        messageInput.disabled = isAtLimit;

        if (isAtLimit) {
          messageInput.placeholder = "Rate limit reached. Please wait...";
          showRateLimitWarning();
        } else {
          messageInput.placeholder = isOCRMode
            ? "OCR Mode: Upload images to extract text! 🐧📄"
            : "Message PipAI... Try uploading images, asking for translations, or generating QR codes! 🐧";
          hideRateLimitWarning();
        }
      }

      function showRateLimitWarning() {
        rateLimitWarning.classList.remove("hidden");
        startCooldownTimer();
      }

      function hideRateLimitWarning() {
        rateLimitWarning.classList.add("hidden");
        if (cooldownTimer) {
          clearInterval(cooldownTimer);
          cooldownTimer = null;
        }
      }

      function startCooldownTimer() {
        if (cooldownTimer) clearInterval(cooldownTimer);

        const oldestTimestamp = Math.min(...questionTimestamps);
        const timeUntilReset =
          RATE_LIMIT_WINDOW - (Date.now() - oldestTimestamp);
        let secondsLeft = Math.ceil(timeUntilReset / 1000);

        cooldownTime.textContent = secondsLeft;

        cooldownTimer = setInterval(() => {
          secondsLeft--;
          cooldownTime.textContent = secondsLeft;

          if (secondsLeft <= 0) {
            updateQuestionCount();
          }
        }, 1000);
      }

      function canSendMessage() {
        const now = Date.now();
        questionTimestamps = questionTimestamps.filter(
          (timestamp) => now - timestamp < RATE_LIMIT_WINDOW
        );
        return questionTimestamps.length < MAX_QUESTIONS_PER_MINUTE;
      }

      function recordQuestion() {
        questionTimestamps.push(Date.now());
        updateQuestionCount();
      }

      // Theme management (keeping existing)
      function initTheme() {
        const savedTheme = localStorage.getItem("pipai-theme");
        if (
          savedTheme === "dark" ||
          (!savedTheme &&
            window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark-mode");
          themeToggle.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                    Light mode
                `;
        }
      }

      function toggleTheme() {
        const isDark = document.documentElement.classList.toggle("dark-mode");
        localStorage.setItem("pipai-theme", isDark ? "dark" : "light");
        themeToggle.innerHTML = isDark
          ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
                Light mode`
          : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="4"/><path d="M12 1v6m0 6v6"/>
                </svg>
                Dark mode`;
      }

      // Chat history functions (keeping existing structure)
      function saveChatHistory() {
        const chatHistory = JSON.parse(
          localStorage.getItem("pipai-chat-history") || "[]"
        );
        const currentChat = {
          id: currentChatId,
          timestamp: new Date().toISOString(),
          messages: messages.filter((msg) => msg.role !== "system"),
          preview: getPreviewText(),
        };

        const filteredHistory = chatHistory.filter(
          (chat) => chat.id !== currentChatId
        );
        filteredHistory.unshift(currentChat);
        const trimmedHistory = filteredHistory.slice(0, 20);
        localStorage.setItem(
          "pipai-chat-history",
          JSON.stringify(trimmedHistory)
        );
        loadChatHistory();
      }

      function loadChatHistory() {
        const chatHistory = JSON.parse(
          localStorage.getItem("pipai-chat-history") || "[]"
        );
        historyList.innerHTML = "";

        if (chatHistory.length === 0) {
          historyList.innerHTML =
            '<div class="text-gray-500 text-sm p-4 text-center">No conversations yet</div>';
          return;
        }

        chatHistory.forEach((chat) => {
          const historyItem = document.createElement("div");
          historyItem.className =
            "history-item p-3 rounded-lg cursor-pointer flex items-center justify-between group";
          historyItem.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="text-sm text-gray-900 dark:text-white truncate">${
                          chat.preview
                        }</div>
                        <div class="text-xs text-gray-500 mt-1">${new Date(
                          chat.timestamp
                        ).toLocaleDateString()}</div>
                    </div>
                    <button class="delete-chat-btn opacity-0 group-hover:opacity-100 p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded" data-chat-id="${
                      chat.id
                    }">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                `;

          historyItem.addEventListener("click", (e) => {
            if (!e.target.closest(".delete-chat-btn")) {
              loadChat(chat);
            }
          });

          historyList.appendChild(historyItem);
        });

        document.querySelectorAll(".delete-chat-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            deleteChat(btn.dataset.chatId);
          });
        });
      }

      function loadChat(chat) {
        messages = [
          {
            role: "system",
            content:
              "You are PipAI, an advanced penguin-themed AI assistant created by Prahath Kambaiyyagari. You have enhanced capabilities including image analysis, OCR text extraction, voice interaction, translation, and QR code generation. Always be enthusiastic, helpful, and include penguin emojis 🐧. When users upload images, analyze them thoroughly. For OCR requests, extract and format text clearly. Be conversational and showcase your advanced features naturally.",
          },
          ...chat.messages,
        ];
        currentChatId = chat.id;

        const messagesContainer = chatContainer.querySelector(".max-w-4xl");
        messagesContainer.innerHTML = "";
        chat.messages.forEach((msg) => {
          displayMessage(
            msg.content,
            msg.role,
            msg.images || [],
            msg.gifs || [],
            msg.movies || [],
            msg.news || []
          );
        });

        if (window.innerWidth < 768) {
          sidebar.classList.remove("open");
        }
      }

      function deleteChat(chatId) {
        const chatHistory = JSON.parse(
          localStorage.getItem("pipai-chat-history") || "[]"
        );
        const filteredHistory = chatHistory.filter(
          (chat) => chat.id !== chatId
        );
        localStorage.setItem(
          "pipai-chat-history",
          JSON.stringify(filteredHistory)
        );
        loadChatHistory();
      }

      function getPreviewText() {
        const userMessages = messages.filter((msg) => msg.role === "user");
        if (userMessages.length === 0) return "New conversation";
        return (
          userMessages[0].content.substring(0, 40) +
          (userMessages[0].content.length > 40 ? "..." : "")
        );
      }

      function startNewChat() {
        messages = [
          {
            role: "system",
            content:
              "You are PipAI, an advanced penguin-themed AI assistant created by Prahath Kambaiyyagari. You have enhanced capabilities including image analysis, OCR text extraction, voice interaction, translation, and QR code generation. Always be enthusiastic, helpful, and include penguin emojis 🐧. When users upload images, analyze them thoroughly. For OCR requests, extract and format text clearly. Be conversational and showcase your advanced features naturally.",
          },
        ];
        currentChatId = Date.now().toString();
        const messagesContainer = chatContainer.querySelector(".max-w-4xl");
        messagesContainer.innerHTML = "";

        // Clear uploaded images
        uploadedImages = [];
        imagePreviewContainer.innerHTML = "";
        imageUploadArea.classList.add("hidden");

        displayMessage(
          "Hi there! I'm PipAI Enhanced! 🐧✨ I've got amazing new features including:\n\n🖼️ **Image Upload & Analysis** - Drop images for analysis!\n📄 **OCR Text Extraction** - Extract text from images\n🎤 **Voice Input** - Speak to me directly\n🌐 **Real-time Translation** - Translate any text\n📱 **QR Code Generator** - Create QR codes instantly\n\nTry uploading an image or ask me anything! I'm super excited to help! 🚀",
          "assistant"
        );

        if (window.innerWidth < 768) {
          sidebar.classList.remove("open");
        }
      }

      function clearAllHistory() {
        if (confirm("Clear all conversations?")) {
          localStorage.removeItem("pipai-chat-history");
          loadChatHistory();
        }
      }

      // Enhanced Chat functionality
      async function sendMessage() {
        const userInput = messageInput.value.trim();
        if ((!userInput && uploadedImages.length === 0) || isLoading) return;

        if (!canSendMessage()) {
          showRateLimitWarning();
          return;
        }

        isLoading = true;
        recordQuestion();

        // Display user message with images
        let userMessage = userInput;
        if (uploadedImages.length > 0) {
          userMessage += `\n\n[Uploaded ${
            uploadedImages.length
          } image(s): ${uploadedImages.map((img) => img.name).join(", ")}]`;
        }

        displayMessage(userMessage, "user");
        messages.push({ role: "user", content: userInput });

        messageInput.value = "";
        autoResizeTextarea();

        const loadingMessage = showLoadingIndicator();

        try {
          let images = [];
          let gifs = [];
          let movies = [];
          let news = [];

          // Fetch data from all relevant APIs
          if (isImageRequest(userInput)) {
            const imageQuery = extractQuery(userInput, [
              "image",
              "images",
              "picture",
              "pictures",
              "photo",
              "photos",
              "show me",
              "find",
              "search",
            ]);
            images = await searchImages(imageQuery);
          }

          if (isGifRequest(userInput)) {
            const gifQuery = extractQuery(userInput, [
              "gif",
              "gifs",
              "animated",
              "show me",
              "find",
              "search",
            ]);
            gifs = await searchGifs(gifQuery);
          }

          if (isMovieRequest(userInput)) {
            const movieQuery = extractQuery(userInput, [
              "movie",
              "movies",
              "film",
              "films",
              "show me",
              "find",
              "search",
            ]);
            movies = await searchMovies(movieQuery);
          }

          if (isNewsRequest(userInput)) {
            const newsQuery = extractQuery(userInput, [
              "news",
              "headline",
              "headlines",
              "article",
              "articles",
              "show me",
              "find",
              "search",
            ]);
            news = await searchNews(newsQuery);
          }

          // Create enhanced context with uploaded images
          const contextData = createContextData(
            movies,
            news,
            images,
            gifs,
            uploadedImages
          );
          let enhancedMessage = userInput;

          if (contextData || uploadedImages.length > 0) {
            enhancedMessage += "\n\nContext:";
            if (uploadedImages.length > 0) {
              enhancedMessage += `\nUser uploaded ${uploadedImages.length} image(s). Please analyze and provide insights about the uploaded images.`;
            }
            if (contextData) {
              enhancedMessage += contextData;
            }
            enhancedMessage +=
              "\nPlease provide a comprehensive response using this information and showcase your advanced AI capabilities.";
          }

          const enhancedMessages = [
            ...messages.slice(0, -1),
            { role: "user", content: enhancedMessage },
          ];

          // Call Cerebras API
          const response = await fetch(
            "https://api.cerebras.ai/v1/chat/completions",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${cerebrasApiKey}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model: "llama3.1-8b",
                messages: enhancedMessages,
                max_tokens: 400,
                temperature: 0.7,
              }),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error?.message ||
                `HTTP error! Status: ${response.status}`
            );
          }

          const data = await response.json();
          let aiResponse = data.choices[0].message.content;

          const messageData = {
            role: "assistant",
            content: aiResponse,
            images: images,
            gifs: gifs,
            movies: movies,
            news: news,
          };

          messages.push(messageData);
          loadingMessage.remove();

          displayMessage(aiResponse, "assistant", images, gifs, movies, news);
          saveChatHistory();

          // Clear uploaded images after sending
          uploadedImages = [];
          imagePreviewContainer.innerHTML = "";
          imageUploadArea.classList.add("hidden");
        } catch (error) {
          console.error("Error:", error);
          loadingMessage.remove();
          displayMessage(
            `Oops! I encountered an error: ${error.message} 🐧 Please try again! My advanced features are still learning!`,
            "error"
          );
        } finally {
          isLoading = false;
          updateQuestionCount();
        }
      }

      function displayMessage(
        message,
        role,
        images = [],
        gifs = [],
        movies = [],
        news = []
      ) {
        const messagesContainer = chatContainer.querySelector(".max-w-4xl");
        const messageElement = document.createElement("div");

        if (role === "user") {
          messageElement.className = "mb-6 flex justify-end";
          messageElement.innerHTML = `
                    <div class="user-message max-w-2xl px-4 py-3 rounded-2xl">
                        <div class="whitespace-pre-wrap">${message}</div>
                    </div>
                `;
        } else if (role === "assistant") {
          messageElement.className = "mb-6";
          let htmlContent = message
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>")
            .replace(/\n/g, "<br>");

          let contentHtml = "";

          if (images && images.length > 0) {
            contentHtml += createImageGallery(images, "search results");
          }

          if (gifs && gifs.length > 0) {
            contentHtml += createGifGallery(gifs, "search results");
          }

          if (movies && movies.length > 0) {
            contentHtml += createMovieList(movies);
          }

          if (news && news.length > 0) {
            contentHtml += createNewsList(news);
          }

          messageElement.innerHTML = `
                    <div class="ai-message py-2">
                        <div class="flex items-start gap-3">
                            <span class="text-xl mt-1 sparkle">🐧</span>
                            <div class="flex-1">
                                <div class="text-gray-900 dark:text-white whitespace-pre-wrap">${htmlContent}</div>
                                ${contentHtml}
                            </div>
                        </div>
                    </div>
                `;
        } else if (role === "error") {
          messageElement.className = "mb-6";
          messageElement.innerHTML = `
                    <div class="ai-message py-2">
                        <div class="flex items-start gap-3">
                            <span class="text-xl mt-1">⚠️</span>
                            <div class="flex-1">
                                <div class="text-red-600 dark:text-red-400 whitespace-pre-wrap">${message}</div>
                            </div>
                        </div>
                    </div>
                `;
        }

        messagesContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function showLoadingIndicator() {
        const messagesContainer = chatContainer.querySelector(".max-w-4xl");
        const loadingElement = document.createElement("div");
        loadingElement.className = "mb-6";
        loadingElement.innerHTML = `
                <div class="ai-message py-2">
                    <div class="flex items-start gap-3">
                        <span class="text-xl mt-1 sparkle">🐧</span>
                        <div class="flex-1">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        messagesContainer.appendChild(loadingElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return loadingElement;
      }

      // Event listeners
      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        sendMessage();
      });

      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      newChatBtn.addEventListener("click", startNewChat);
      clearHistoryBtn.addEventListener("click", clearAllHistory);
      themeToggle.addEventListener("click", toggleTheme);

      sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("open");
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeImageModal();
          closeQRModal();
        }
      });

      // Make functions globally accessible
      window.removeImage = removeImage;
      window.openImageModal = openImageModal;
      window.closeImageModal = closeImageModal;
      window.generateQRCode = generateQRCode;
      window.closeQRModal = closeQRModal;
      window.toggleVoiceMode = toggleVoiceMode;
      window.toggleOCRMode = toggleOCRMode;
      window.generateQR = generateQR;
      window.toggleTranslator = toggleTranslator;

      // Initialize everything
      initTheme();
      setupImageUpload();
      loadChatHistory();
      startNewChat();
      updateQuestionCount();
      setInterval(updateQuestionCount, 5000);
    </script>
  </body>
</html>
