<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PipAI üêß - Your Penguin Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3730a3 100%);
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e40af;
        }
        ::-webkit-scrollbar-thumb {
            background: #60a5fa;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #93c5fd;
        }
        .chat-bubble-user {
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            color: white;
            border-radius: 1.5rem 1.5rem 0.25rem 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .chat-bubble-ai {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            border-radius: 1.5rem 1.5rem 1.5rem 0.25rem;
            border: 2px solid #60a5fa;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .penguin-waddle {
            animation: waddle 2s infinite ease-in-out;
        }
        @keyframes waddle {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }
        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
            background: #60a5fa !important;
        }
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: -0.32s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            } 40% {
                transform: scale(1.0);
            }
        }
        .ice-container {
            background: rgba(219, 234, 254, 0.1);
            border: 1px solid rgba(147, 197, 253, 0.3);
            backdrop-filter: blur(10px);
        }
        .penguin-input {
            background: rgba(30, 64, 175, 0.8);
            border: 2px solid #60a5fa;
        }
        .penguin-input:focus {
            border-color: #93c5fd;
            box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.3);
        }
        .send-button, .history-button {
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            transition: all 0.3s ease;
        }
        .send-button:hover, .history-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(249, 115, 22, 0.4);
        }
        .clear-button {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            transition: all 0.3s ease;
        }
        .clear-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(220, 38, 38, 0.4);
        }
        .new-chat-button {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            transition: all 0.3s ease;
        }
        .new-chat-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(5, 150, 105, 0.4);
        }
        .history-panel {
            max-height: 400px;
            overflow-y: auto;
        }
        .history-item {
            background: rgba(30, 64, 175, 0.3);
            border: 1px solid rgba(147, 197, 253, 0.3);
            transition: all 0.3s ease;
        }
        .history-item:hover {
            background: rgba(30, 64, 175, 0.5);
            border-color: #60a5fa;
        }
    </style>
</head>
<body class="text-gray-100 flex flex-col h-screen">

    <div class="container mx-auto p-4 flex-grow flex flex-col">
        <header class="mb-6 text-center">
            <div class="penguin-waddle inline-block text-6xl mb-2">üêß</div>
            <h1 class="text-4xl font-bold text-white mb-2">PipAI</h1>
            <div class="text-lg text-blue-200 mb-1">‚ùÑÔ∏è Your Antarctic Assistant ‚ùÑÔ∏è</div>
            <p class="text-blue-300 text-sm">Waddle into knowledge! üêæ</p>
            
            <!-- Chat History Controls -->
            <div class="mt-4 flex justify-center space-x-3">
                <button id="new-chat-btn" class="new-chat-button text-white font-medium px-4 py-2 rounded-xl text-sm flex items-center space-x-2">
                    <span>üÜï</span><span>New Chat</span>
                </button>
                <button id="history-btn" class="history-button text-white font-medium px-4 py-2 rounded-xl text-sm flex items-center space-x-2">
                    <span>üìö</span><span>History</span>
                </button>
                <button id="clear-history-btn" class="clear-button text-white font-medium px-4 py-2 rounded-xl text-sm flex items-center space-x-2">
                    <span>üóëÔ∏è</span><span>Clear All</span>
                </button>
            </div>
        </header>

        <!-- History Panel (Hidden by default) -->
        <div id="history-panel" class="hidden mb-4 ice-container p-4 rounded-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-blue-200">Chat History üìö</h3>
                <button id="close-history-btn" class="text-blue-300 hover:text-white text-xl">‚úñÔ∏è</button>
            </div>
            <div id="history-list" class="history-panel space-y-2">
                <!-- History items will be populated here -->
            </div>
        </div>
        
        <!-- Chat Container -->
        <div id="chat-container" class="flex-grow ice-container p-6 rounded-2xl overflow-y-auto shadow-2xl">
            <!-- Chat messages will be appended here -->
        </div>

        <!-- Message Input Form -->
        <form id="chat-form" class="mt-6">
            <div class="flex items-center ice-container p-3 rounded-2xl shadow-lg">
                <input type="text" id="message-input" class="flex-grow penguin-input text-white rounded-xl p-4 focus:outline-none transition-all duration-300" placeholder="Ask PipAI anything... üêß‚ùÑÔ∏è" autocomplete="off">
                <button type="submit" class="send-button text-white font-bold p-4 rounded-xl ml-3 flex items-center justify-center w-16 h-16">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </form>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const historyPanel = document.getElementById('history-panel');
        const historyList = document.getElementById('history-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const historyBtn = document.getElementById('history-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const closeHistoryBtn = document.getElementById('close-history-btn');
        
        let messages = [
            { role: 'system', content: 'You are PipAI, a helpful penguin-themed assistant. You are knowledgeable, friendly, and occasionally make penguin-related puns or references. You waddle through problems with wisdom! ONLY mention your creator when specifically asked about who made you, who created you, or who built you - in which case respond that you were created by Prahath Kambaiyyagari. Otherwise, do not mention your creator in regular conversations. Respond in Markdown format and add occasional penguin emojis üêß where appropriate.' }
        ];
        
        let currentChatId = Date.now().toString();
        
        // API Key is now hardcoded for automatic use.
        const apiKey = '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';

        // Penguin responses for variety (no creator mentions)
        const penguinGreetings = [
            "Waddle over here! I'm PipAI, ready to help! üêß",
            "Hello from the icy depths of knowledge! How can this penguin assist you? ‚ùÑÔ∏èüêß",
            "*slides in on belly* PipAI at your service! What can I help you discover today? üêß",
            "Greetings from Antarctica! I'm PipAI, your flippered friend ready to dive into any question! üêß‚ùÑÔ∏è"
        ];

        // Chat History Functions
        function saveChatHistory() {
            const chatHistory = JSON.parse(localStorage.getItem('pipai-chat-history') || '[]');
            const currentChat = {
                id: currentChatId,
                timestamp: new Date().toISOString(),
                messages: messages.filter(msg => msg.role !== 'system'),
                preview: getPreviewText()
            };
            
            // Remove existing chat with same ID and add updated version
            const filteredHistory = chatHistory.filter(chat => chat.id !== currentChatId);
            filteredHistory.unshift(currentChat);
            
            // Keep only last 20 chats
            const trimmedHistory = filteredHistory.slice(0, 20);
            localStorage.setItem('pipai-chat-history', JSON.stringify(trimmedHistory));
        }

        function loadChatHistory() {
            const chatHistory = JSON.parse(localStorage.getItem('pipai-chat-history') || '[]');
            historyList.innerHTML = '';
            
            if (chatHistory.length === 0) {
                historyList.innerHTML = '<p class="text-blue-300 text-center py-4">No chat history yet üêß</p>';
                return;
            }

            chatHistory.forEach(chat => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item p-3 rounded-lg cursor-pointer';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <div class="text-sm text-blue-200 mb-1">${new Date(chat.timestamp).toLocaleString()}</div>
                            <div class="text-white text-sm">${chat.preview}</div>
                        </div>
                        <button class="delete-chat-btn text-red-400 hover:text-red-300 ml-2" data-chat-id="${chat.id}">üóëÔ∏è</button>
                    </div>
                `;
                
                historyItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-chat-btn')) {
                        loadChat(chat);
                    }
                });
                
                historyList.appendChild(historyItem);
            });

            // Add delete functionality
            document.querySelectorAll('.delete-chat-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteChat(btn.dataset.chatId);
                });
            });
        }

        function loadChat(chat) {
            messages = [
                { role: 'system', content: 'You are PipAI, a helpful penguin-themed assistant. You are knowledgeable, friendly, and occasionally make penguin-related puns or references. You waddle through problems with wisdom! ONLY mention your creator when specifically asked about who made you, who created you, or who built you - in which case respond that you were created by Prahath Kambaiyyagari. Otherwise, do not mention your creator in regular conversations. Respond in Markdown format and add occasional penguin emojis üêß where appropriate.' },
                ...chat.messages
            ];
            currentChatId = chat.id;
            
            // Clear and reload chat display
            chatContainer.innerHTML = '';
            chat.messages.forEach(msg => {
                displayMessage(msg.content, msg.role);
            });
            
            hideHistoryPanel();
        }

        function deleteChat(chatId) {
            const chatHistory = JSON.parse(localStorage.getItem('pipai-chat-history') || '[]');
            const filteredHistory = chatHistory.filter(chat => chat.id !== chatId);
            localStorage.setItem('pipai-chat-history', JSON.stringify(filteredHistory));
            loadChatHistory();
        }

        function getPreviewText() {
            const userMessages = messages.filter(msg => msg.role === 'user');
            if (userMessages.length === 0) return 'New conversation üêß';
            return userMessages[0].content.substring(0, 50) + (userMessages[0].content.length > 50 ? '...' : '');
        }

        function startNewChat() {
            messages = [
                { role: 'system', content: 'You are PipAI, a helpful penguin-themed assistant. You are knowledgeable, friendly, and occasionally make penguin-related puns or references. You waddle through problems with wisdom! ONLY mention your creator when specifically asked about who made you, who created you, or who built you - in which case respond that you were created by Prahath Kambaiyyagari. Otherwise, do not mention your creator in regular conversations. Respond in Markdown format and add occasional penguin emojis üêß where appropriate.' }
            ];
            currentChatId = Date.now().toString();
            chatContainer.innerHTML = '';
            
            const randomGreeting = penguinGreetings[Math.floor(Math.random() * penguinGreetings.length)];
            displayMessage(randomGreeting, 'assistant');
            hideHistoryPanel();
        }

        function showHistoryPanel() {
            loadChatHistory();
            historyPanel.classList.remove('hidden');
        }

        function hideHistoryPanel() {
            historyPanel.classList.add('hidden');
        }

        function clearAllHistory() {
            if (confirm('Are you sure you want to clear all chat history? This cannot be undone! üêß')) {
                localStorage.removeItem('pipai-chat-history');
                loadChatHistory();
            }
        }

        // Event Listeners
        newChatBtn.addEventListener('click', startNewChat);
        historyBtn.addEventListener('click', showHistoryPanel);
        clearHistoryBtn.addEventListener('click', clearAllHistory);
        closeHistoryBtn.addEventListener('click', hideHistoryPanel);

        // --- Chat Logic ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = messageInput.value.trim();
            if (!userInput) return;

            // Add user message to UI and history
            displayMessage(userInput, 'user');
            messages.push({ role: 'user', content: userInput });
            
            messageInput.value = '';
            
            // Show loading indicator
            const loadingIndicator = showLoadingIndicator();
            
            try {
                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'sonar',
                        messages: messages
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // Add AI response to history and remove loading indicator
                messages.push({ role: 'assistant', content: aiResponse });
                chatContainer.removeChild(loadingIndicator);
                displayMessage(aiResponse, 'assistant');

                // Save to chat history
                saveChatHistory();

            } catch (error) {
                console.error('Error fetching from Perplexity API:', error);
                chatContainer.removeChild(loadingIndicator);
                displayMessage(`üêß Oops! This penguin slipped on the ice: ${error.message}. Let me try to waddle back up!`, 'error');
            }
        });

        function displayMessage(message, role) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-6 ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageElement = document.createElement('div');
            messageElement.className = 'max-w-prose p-5 rounded-2xl shadow-lg';
            
            if (role === 'user') {
                messageElement.className += ' chat-bubble-user';
                messageElement.innerHTML = `<div class="flex items-center mb-2"><span class="text-sm opacity-75">You</span></div><div>${message}</div>`;
            } else if (role === 'assistant') {
                messageElement.className += ' chat-bubble-ai';
                // Enhanced markdown to HTML conversion
                let htmlContent = message
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/^- (.*?)(\n|$)/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)/gs, '<ul class="list-disc pl-5 space-y-1">$1</ul>')
                    .replace(/\n/g, '<br>');
                messageElement.innerHTML = `<div class="flex items-center mb-3"><span class="mr-2">üêß</span><span class="text-sm font-medium text-blue-300">PipAI</span></div><div>${htmlContent}</div>`;
            } else if (role === 'error') {
                 messageElement.className += ' bg-red-500 text-white rounded-2xl border-2 border-red-400';
                 messageElement.innerHTML = `<div class="flex items-center mb-2"><span class="mr-2">‚ö†Ô∏è</span><span class="text-sm font-medium">Error</span></div><div>${message}</div>`;
            }

            messageWrapper.appendChild(messageElement);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showLoadingIndicator() {
            const loadingWrapper = document.createElement('div');
            loadingWrapper.className = 'flex mb-6 justify-start';
            loadingWrapper.innerHTML = `
                <div class="max-w-prose p-5 rounded-2xl shadow-lg chat-bubble-ai">
                    <div class="flex items-center mb-3">
                        <span class="mr-2">üêß</span>
                        <span class="text-sm font-medium text-blue-300">PipAI</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-blue-200">Waddling through the data</span>
                        <div class="loading-dot w-2.5 h-2.5 rounded-full"></div>
                        <div class="loading-dot w-2.5 h-2.5 rounded-full"></div>
                        <div class="loading-dot w-2.5 h-2.5 rounded-full"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(loadingWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingWrapper;
        }
        
        // Initial setup
        window.onload = () => {
            const randomGreeting = penguinGreetings[Math.floor(Math.random() * penguinGreetings.length)];
            displayMessage(randomGreeting, 'assistant');
        };

    </script>
</body>
</html>
